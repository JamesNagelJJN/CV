import cv2
import matplotlib.pyplot as plt
import numpy as np
import os
from keras.layers import Dense, Flatten, Conv2D, MaxPooling2D
from keras import Sequential
from sklearn.model_selection import train_test_split
import random

path_data_GT = r'\Users...'
path_data = r'\Users...'

class_names = ['Black Sea Sprat','Gilt-Head Bream',
               'Hourse Mackerel','Red Mullet','Red Sea Bream',
               'Sea Bass','Shrimp','Striped Red Mullet','Trout']

class_names_GT = ['Black Sea Sprat GT','Gilt-Head Bream GT',
               'Hourse Mackerel GT','Red Mullet GT','Red Sea Bream GT',
               'Sea Bass GT','Shrimp GT','Striped Red Mullet GT','Trout GT']

IMG_SIZE = 50
IMG_SIZE_LIST = []


def load_images_from_folder(IMG_SIZE,class_name,path_to_img):
    training_data = []
    X = []
    y = []
    for category in class_name:
        path = os.path.join(path_to_img,category)
        class_num = class_name.index(category)
        for img in os.listdir(path):
            img = cv2.imread(os.path.join(path, img))
            img = cv2.resize(img, (IMG_SIZE,IMG_SIZE), interpolation = cv2.INTER_AREA)
            training_data.append([img,class_num])
    for features,label in training_data:
        X.append(features)
        y.append(label)
    print(np.array(X).shape)
    random.shuffle(training_data)
    return X,y


def cnn(IMG_SIZE, X, y):

    val_stats = []

    X = np.array(X)
    y = np.array(y)
    print(X.shape)

    X_train, X_test, y_train, y_test = train_test_split(X,y,test_size=0.25)

    model = Sequential()

    model.add(Conv2D(32,(2,2), input_shape=(IMG_SIZE,IMG_SIZE,3), activation='relu'))
    model.add(MaxPooling2D(2,2))
    model.add(Conv2D(32,(2,2), activation='relu'))
    model.add(MaxPooling2D(2,2))
    model.add(Flatten())
    model.add(Dense(units=512, activation='relu'))
    model.add(Dense(units=256, activation='relu'))
    model.add(Dense(units=9, activation='softmax'))
    model.compile(optimizer='adam',
                  loss='sparse_categorical_crossentropy',
                  metrics=['accuracy'])
    history = model.fit(X_train, y_train, epochs=20, batch_size=250, verbose=1, validation_data=(X_test,y_test))
    val_loss, val_acc = model.evaluate(X_test,y_test)
    val_stats.append([val_loss,val_acc])
    return (history, val_stats)


for i in range(5):
    X,y = load_images_from_folder(IMG_SIZE,class_names_GT,path_data_GT)
    history, new_val_stats = cnn(IMG_SIZE,X,y)

    val_losses = []
    val_accuracy = []

    for w,v in new_val_stats:
        val_losses.append(w)
        val_accuracy.append(v)

    #plt.plot(history.history['accuracy'], label='accuracy')
    plt.plot(history.history['val_accuracy'], label=IMG_SIZE)
    IMG_SIZE_LIST.append(IMG_SIZE)
    IMG_SIZE -= 10


handles, labels = plt.gca().get_legend_handles_labels()

reversed_labels = list(reversed(labels))

x_ticks = [0,5,10,15,20]
y_ticks = [0,0.25,0.5,0.75,1]
plt.xlabel('Epochs')
plt.ylabel('Accuracy')
plt.xticks(x_ticks)
plt.yticks(y_ticks)
plt.title('Accuracy of fish classiciation CNN BLACK-WHITE')
plt.legend(labels,loc='lower right')
plt.show()
